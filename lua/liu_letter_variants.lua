-- liu_letter_variants.lua
-- 擴充模式下的字母變化形
-- ``a = 小寫變化形（ā á ǎ à...）
-- ``A (Shift+a) = 大寫變化形（Ā Á Ǎ À...）

-- 從共用模組取得選單資料
local extended_data = require("liu_extended_data")
local EXTENDED_MENU = extended_data.EXTENDED_MENU

-- 大寫字母變化形（`aa 到 `zz）
local letter_variants_upper = {
  ["A"] = {"Ā", "Á", "Ǎ", "À", "Â", "Ä", "Ã", "Å", "Ȧ", "Ă", "Ą", "Ǻ", "Ǟ", "Ǡ", "Ȁ", "Ȃ", "Ⱥ", "Ḁ", "Ạ", "Ả", "Ấ", "Ầ", "Ẩ", "Ẫ", "Ậ", "Ắ", "Ằ", "Ẳ", "Ẵ", "Ặ"},
  ["B"] = {"Ḃ", "Ḅ", "Ḇ", "Ɓ", "Ƃ"},
  ["C"] = {"Ć", "Ĉ", "Č", "Ċ", "Ç", "Ƈ", "Ȼ", "Ḉ"},
  ["D"] = {"Ḋ", "Ď", "Đ", "Ḍ", "Ḏ", "Ḑ", "Ḓ", "Ɖ", "Ɗ", "Ƌ", "Ǆ", "Ǳ"},
  ["E"] = {"Ē", "É", "Ě", "È", "Ê", "Ë", "Ẽ", "Ė", "Ĕ", "Ę", "Ȩ", "Ɇ", "Ế", "Ề", "Ể", "Ễ", "Ệ", "Ḕ", "Ḗ", "Ḙ", "Ḛ", "Ẹ", "Ẻ", "Ȅ", "Ȇ", "Ǝ", "Ə", "Ɛ"},
  ["F"] = {"Ḟ", "Ƒ"},
  ["G"] = {"Ḡ", "Ǵ", "Ǧ", "Ğ", "Ĝ", "Ġ", "Ģ", "Ǥ", "Ɠ"},
  ["H"] = {"Ḣ", "Ȟ", "Ĥ", "Ħ", "Ḧ", "Ḩ", "Ḫ", "Ⱨ"},
  ["I"] = {"Ī", "Í", "Ǐ", "Ì", "Î", "Ï", "Ĩ", "Į", "İ", "Ȉ", "Ȋ", "Ɨ", "Ḭ", "Ḯ", "Ỉ", "Ị"},
  ["J"] = {"Ĵ", "Ɉ"},
  ["K"] = {"Ḱ", "Ǩ", "Ķ", "Ḳ", "Ḵ", "Ƙ", "Ⱪ"},
  ["L"] = {"Ĺ", "Ľ", "Ļ", "Ł", "Ḷ", "Ḹ", "Ḻ", "Ḽ", "Ƚ", "Ⱡ", "Ɫ"},
  ["M"] = {"Ḿ", "Ṁ", "Ṃ", "Ɯ"},
  ["N"] = {"Ń", "Ǹ", "Ň", "Ñ", "Ņ", "Ṅ", "Ṇ", "Ṉ", "Ṋ", "Ɲ", "Ƞ"},
  ["O"] = {"Ō", "Ó", "Ǒ", "Ò", "Ô", "Ö", "Õ", "Ø", "Ő", "Ȯ", "Ŏ", "Ǫ", "Ǭ", "Ǿ", "Ȍ", "Ȏ", "Ȫ", "Ȭ", "Ȱ", "Ṍ", "Ṏ", "Ṑ", "Ṓ", "Ọ", "Ỏ", "Ố", "Ồ", "Ổ", "Ỗ", "Ộ", "Ớ", "Ờ", "Ở", "Ỡ", "Ợ", "Ɵ", "Œ"},
  ["P"] = {"Ṕ", "Ṗ", "Ƥ", "Ᵽ"},
  ["Q"] = {"Ɋ"},
  ["R"] = {"Ŕ", "Ř", "Ŗ", "Ṙ", "Ṛ", "Ṝ", "Ṟ", "Ȑ", "Ȓ", "Ɍ"},
  ["S"] = {"Ś", "Ŝ", "Š", "Ş", "Ș", "Ṡ", "Ṣ", "Ṥ", "Ṧ", "Ṩ"},
  ["T"] = {"Ṫ", "Ť", "Ţ", "Ț", "Ṭ", "Ṯ", "Ṱ", "Ŧ", "Ƭ", "Ʈ", "Ⱦ"},
  ["U"] = {"Ū", "Ú", "Ǔ", "Ù", "Û", "Ü", "Ǖ", "Ǘ", "Ǚ", "Ǜ", "Ũ", "Ů", "Ű", "Ų", "Ư", "Ȕ", "Ȗ", "Ʉ", "Ṳ", "Ṵ", "Ṷ", "Ṹ", "Ṻ", "Ụ", "Ủ", "Ứ", "Ừ", "Ử", "Ữ", "Ự"},
  ["V"] = {"Ṽ", "Ṿ", "Ʋ"},
  ["W"] = {"Ẁ", "Ẃ", "Ŵ", "Ẅ", "Ẇ", "Ẉ", "Ⱳ"},
  ["X"] = {"Ẋ", "Ẍ"},
  ["Y"] = {"Ȳ", "Ý", "Ỳ", "Ŷ", "Ÿ", "Ỹ", "Ẏ", "Ỷ", "Ỵ", "Ƴ"},
  ["Z"] = {"Ź", "Ž", "Ż", "Ẑ", "Ẓ", "Ẕ", "Ƶ", "Ȥ", "Ⱬ"},
}

-- 小寫字母變化形（`a 到 `z）
local letter_variants_lower = {
  ["a"] = {"ā", "á", "ǎ", "à", "â", "ä", "ã", "å", "ȧ", "ă", "ą", "ǻ", "ǟ", "ǡ", "ȁ", "ȃ", "ⱥ", "ḁ", "ạ", "ả", "ấ", "ầ", "ẩ", "ẫ", "ậ", "ắ", "ằ", "ẳ", "ẵ", "ặ", "ₐ", "ᵃ", "ª", "ᵄ", "ᶏ", "ẚ", "ɐ", "ɑ", "ɒ", "ᶛ", "ᵅ"},
  ["b"] = {"ḃ", "ḅ", "ḇ", "ɓ", "ƀ", "ƃ", "ᵇ", "ᵬ", "ᶀ", "ᵦ", "ᵝ", "β"},
  ["c"] = {"ć", "ĉ", "č", "ċ", "ç", "ƈ", "ȼ", "ḉ", "ᶜ", "ᵓ", "ɔ", "ᶗ", "ɕ", "ᶝ"},
  ["d"] = {"ḋ", "ď", "đ", "ḍ", "ḏ", "ḑ", "ḓ", "ɖ", "ɗ", "ƌ", "ᵈ", "ᵭ", "ᶁ", "ᶑ", "ð", "ʤ", "ƍ", "ᶞ", "ǳ", "ǆ", "ʣ", "ʥ", "ȡ", "ẟ"},
  ["e"] = {"ē", "é", "ě", "è", "ê", "ë", "ẽ", "ė", "ĕ", "ę", "ȩ", "ɇ", "ế", "ề", "ể", "ễ", "ệ", "ḕ", "ḗ", "ḙ", "ḛ", "ẹ", "ẻ", "ȅ", "ȇ", "ₑ", "ᵉ", "ᶒ", "ᶟ", "ɛ", "ǝ", "ə", "ₔ", "ᵊ", "ɚ", "ɘ", "ɜ", "ɝ", "ɞ", "ʚ", "ȝ", "ᶾ", "ᶕ", "ᶚ", "ᴈ", "ᶓ", "ᶔ", "ᵋ", "ᵌ", "ⱸ"},
  ["f"] = {"ḟ", "ƒ", "ᶠ", "ᵮ", "ᶂ", "ﬀ", "ﬁ", "ﬂ", "ﬃ", "ﬄ", "ʩ", "ɟ", "ɸ", "ᶲ", "ᵩ", "ᵠ"},
  ["g"] = {"ḡ", "ǵ", "ǧ", "ğ", "ĝ", "ġ", "ģ", "ǥ", "ɠ", "ᵍ", "ᵷ", "ᶃ", "ɣ", "ᶢ", "ɡ", "ˠ", "ᵧ", "ᵞ"},
  ["h"] = {"ḣ", "ȟ", "ĥ", "ħ", "ḧ", "ḩ", "ḫ", "ⱨ", "ͪ", "ɦ", "ẖ", "ɥ", "ᶣ", "ʱ", "ƕ", "ʮ", "ʯ", "ꜧ", "ɧ"},
  ["i"] = {"ī", "í", "ǐ", "ì", "î", "ï", "ĩ", "į", "ı", "ȉ", "ȋ", "ɨ", "ḭ", "ḯ", "ỉ", "ị", "ᵢ", "ᴉ", "ĭ", "ᶤ", "ᶖ", "ᵎ", "ɩ", "ᶥ", "ᵼ", "ĳ"},
  ["j"] = {"ĵ", "ǰ", "ɉ", "ȷ", "ⱼ", "ʲ", "ɟ", "ᶡ", "ʄ", "ᶨ", "ʝ"},
  ["k"] = {"ḱ", "ǩ", "ķ", "ḳ", "ḵ", "ƙ", "ⱪ", "ᵏ", "ᶄ", "ʞ"},
  ["l"] = {"ĺ", "ľ", "ļ", "ł", "ḷ", "ḹ", "ḻ", "ḽ", "ƚ", "ⱡ", "ɫ", "ˡ", "ᶅ", "ᶪ", "ᶩ", "ɭ", "ɬ", "ɮ", "ǉ", "ỻ", "ʪ", "ʫ", "ȴ", "ƛ"},
  ["m"] = {"ḿ", "ṁ", "ṃ", "ɯ", "ᵐ", "ᵯ", "ᶬ", "ɱ", "ᶆ", "ᵚ", "ɰ", "ᶭ", "ᴟ"},
  ["n"] = {"ń", "ǹ", "ň", "ñ", "ņ", "ṅ", "ṇ", "ṉ", "ṋ", "ɲ", "ƞ", "ⁿ", "ᵰ", "ᶮ", "ᶇ", "ɳ", "ᶯ", "ŉ", "ȵ"},
  ["o"] = {"ō", "ó", "ǒ", "ò", "ô", "ö", "õ", "ø", "ő", "ȯ", "ŏ", "ǫ", "ǭ", "ǿ", "ȍ", "ȏ", "ȫ", "ȭ", "ȱ", "ṍ", "ṏ", "ṑ", "ṓ", "ọ", "ỏ", "ố", "ồ", "ổ", "ỗ", "ộ", "ớ", "ờ", "ở", "ỡ", "ợ", "ₒ", "ᵒ", "º", "ɵ", "ᵔ", "ᵕ", "œ", "ȣ", "ᴔ", "ⱺ", "ɷ"},
  ["p"] = {"ṕ", "ṗ", "ƥ", "ᵽ", "ᵖ", "ᵱ", "ᶈ"},
  ["q"] = {"ɋ", "ʠ", "ȹ"},
  ["r"] = {"ŕ", "ř", "ŗ", "ṙ", "ṛ", "ṝ", "ṟ", "ȑ", "ȓ", "ɍ", "ᵣ", "ᵲ", "ᵳ", "ɽ", "ᶉ", "ɹ", "ɺ", "ɻ", "ɼ", "ɾ", "ɿ", "ʳ", "ʴ", "ʵ", "ᵨ"},
  ["s"] = {"ś", "ŝ", "š", "ş", "ș", "ṡ", "ṣ", "ṥ", "ṧ", "ṩ", "ˢ", "ᵴ", "ᶳ", "ʂ", "ᶊ", "ȿ", "ʃ", "ᶴ", "ƨ", "ʆ", "ʅ", "ƪ", "ß", "ſ", "ẛ"},
  ["t"] = {"ṫ", "ť", "ţ", "ț", "ṭ", "ṯ", "ṱ", "ŧ", "ƭ", "ʈ", "ⱦ", "ᵗ", "ᵵ", "ᶵ", "ƫ", "ʇ", "ʧ", "ʨ", "ᶿ", "ȶ"},
  ["u"] = {"ū", "ú", "ǔ", "ù", "û", "ü", "ǖ", "ǘ", "ǚ", "ǜ", "ũ", "ů", "ű", "ų", "ư", "ȕ", "ȗ", "ʉ", "ṳ", "ṵ", "ṷ", "ṹ", "ṻ", "ụ", "ủ", "ứ", "ừ", "ử", "ữ", "ự", "ᵤ", "ᵘ", "ŭ", "ᶶ", "ᶙ", "ʊ", "ᶷ", "ᵙ", "ᵿ", "ᴝ", "ᴞ", "ᵫ"},
  ["v"] = {"ṽ", "ṿ", "ʋ", "ⱴ", "ᵥ", "ᵛ", "ᶹ", "ᶌ", "ᶺ", "ʌ"},
  ["w"] = {"ẁ", "ẃ", "ŵ", "ẅ", "ẇ", "ẉ", "ⱳ", "ʷ", "ẘ", "ƿ", "ʍ"},
  ["x"] = {"ẋ", "ẍ", "ₓ", "ᶍ", "ˣ", "χ", "ᵪ", "ᵡ"},
  ["y"] = {"ȳ", "ý", "ỳ", "ŷ", "ÿ", "ỹ", "ẏ", "ỷ", "ỵ", "ƴ", "ʸ", "ẙ", "ɏ", "ʎ", "ỿ"},
  ["z"] = {"ź", "ž", "ż", "ẑ", "ẓ", "ẕ", "ƶ", "ȥ", "ⱬ", "ᶻ", "ᵶ", "ᶎ", "ᶼ", "ʐ", "ɀ", "ʑ", "ᶽ", "ʒ"},
}

local function translator(input, seg, env)
  -- 調試：記錄輸入和 tag
  -- log.info("liu_letter_variants: input=" .. tostring(input) .. ", has_tag=" .. tostring(seg:has_tag("extended_mode")))
  
  -- 支援兩種情況：
  -- 1. affix_segmentor 移除 prefix 後的輸入（空字串或字母）
  -- 2. 完整輸入（以 `` 開頭）
  
  local clean_input = input
  
  -- 如果是完整輸入（以 `` 開頭），移除 prefix
  if input:match("^``") then
    clean_input = input:sub(3)
  -- 如果不是 extended_mode tag，且不是 `` 開頭，則跳過
  elseif not seg:has_tag("extended_mode") then
    return
  end
  
  -- 空輸入（只有 ``）：不顯示選單（字母變化形已改用長按功能）
  if clean_input == "" then
    -- 不產生任何候選項，讓使用者直接輸入字母
    return
  end
  
  -- 擴充模式下的字母變化形
  -- a = 小寫變化形，A (Shift+a) = 大寫變化形
  
  -- A 到 Z（大寫變化形）- 單個大寫字母（Shift+字母）
  local upper_letter = string.match(clean_input, "^([A-Z])$")
  if upper_letter and letter_variants_upper[upper_letter] then
    -- preedit 格式：《A變化》A
    local preedit = "《" .. upper_letter .. "變化》" .. upper_letter
    for _, symbol in ipairs(letter_variants_upper[upper_letter]) do
      local cand = Candidate("letter_variant", seg.start, seg._end, symbol, "")
      cand.preedit = preedit
      yield(cand)
    end
    return
  end
  
  -- a 到 z（小寫變化形）- 單字母
  local single_letter = string.match(clean_input, "^([a-z])$")
  if single_letter and letter_variants_lower[single_letter] then
    -- preedit 格式：《a變化》a
    local preedit = "《" .. single_letter .. "變化》" .. single_letter
    for _, symbol in ipairs(letter_variants_lower[single_letter]) do
      local cand = Candidate("letter_variant", seg.start, seg._end, symbol, "")
      cand.preedit = preedit
      yield(cand)
    end
    return
  end
end

return translator
